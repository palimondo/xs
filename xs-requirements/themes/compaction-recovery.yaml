# Theme: Compaction Recovery

id: compaction-recovery
name: Context Recovery After Compaction
description: |
  When Claude Code compacts context (automatically or via /compact),
  crucial details are lost in the summary. xs recovers full details
  from the raw transcript.

motivation: |
  Compaction summaries lose:
  - Exact file paths and line numbers edited
  - Specific error messages and stack traces
  - Design rationale discussed during implementation
  - User corrections and clarifications

  For continued work, these details are often critical.

primary_use_cases:
  - Recover context after automatic compaction mid-session
  - Find compaction point in transcript
  - Extract full context from before compaction
  - Automate recovery via hooks

key_capabilities:
  - Search for compaction markers ("This session is being continued")
  - Extract context around compaction point
  - Show full message content (not truncated)
  - Support context lines before/after matches

workflow:
  trigger: Compaction occurs (automatic or /compact)
  steps:
    - PreCompact hook writes flag file
    - PreToolUse hook detects flag on first tool use
    - Hook blocks tool and injects recovery prompt
    - Prompt includes xs commands for context recovery
    - User or Claude uses xs to recover context
    - Flag deleted to prevent repeated triggers

integration_status: |
  Hooks are BookMinder infrastructure (WIP, not fully tested).
  xs provides the data access operations; hooks orchestrate the flow.

  The context_recovery_pattern.md documents the methodology:
  - Find compaction summary via search
  - Read full context at compaction point
  - Check last todo state
  - Focus on WHY behind decisions

related_tools:
  - file: ~/Developer/BookMinder/.claude/hooks/precompact_flag_hook.py
    description: Sets flag when compaction is imminent
  - file: ~/Developer/BookMinder/.claude/hooks/pretooluse_context_recovery_hook.py
    description: Detects flag and injects recovery prompt
  - file: ~/Developer/BookMinder/claude-dev-log-diary/tools/context_recovery_pattern.md
    description: Methodology for effective context recovery

related_epic: context
related_stories:
  - CRH-001 through CRH-007 (7 stories derived from hook analysis)

test_findings: |
  Session 84db provided unplanned real-world test:
  - Exploratory recovery (hook pattern) vs targeted recovery compared
  - Pending questions need fresh responses after compaction
  - Plan files prevent needing full context recovery

status: draft
